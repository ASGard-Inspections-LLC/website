#solution-iterating-page
  #nav.lo-internal-nav-bar
    .lo-container
      =link_to "Dashboard", root_path
      &middot;
      =link_to "#{@track.title}", @track
      &middot;
      -if @solution.exercise.core?
        %span Core Exercises
      -else
        %span Side Quests

  .lo-container
    .track-header
      .icon
      .inner
        .stats
          .stat
            %i.fa.fa-graduation
            .number 12,123
            .metric students
          .stat
            %i.fa.fa-graduation
            .number 39,233
            .metric submits

        .track-title= @track.title
        .track-progress
          %h4 Track Progress:
          -num_core_exercises = @track.exercises.core.count
          -num_completed_exercises = @user_track.num_completed_core_exercies
          -exercise_idx = @track.exercises.core.where("position < ?", @exercise.position).count

          .dots
            -num_core_exercises.times do |i|
              -if i == exercise_idx
                .dot.current
              -elsif i < num_completed_exercises
                .dot.completed
              -else
                .dot

    -if @solution.approved?
      .approved-bar
        %i.fa.fa-bell
        %span.text A mentor has approved this solution
        =link_to "Mark as completed", complete_solution_path(@solution), method: :patch, remote: true, class: 'pure-button'
    /-@notifications.each do |notification|
    /  .notification
    /   =notification.content
    .pure-g.panels
      .pure-u-1-2.lhs
        .lhs-content
          .tabs-and-panes.selected-3
            .tabs
              .tab.tab-1
                Instructions
              .tab.tab-2
                Test Suite
              .tab.tab-3
                Latest Solution

            .panes
              .pane.pane-1
                =@iteration.solution.instructions
              .pane.pane-2
                =@iteration.solution.test_suite
              .pane.pane-3.solution
                %pre.solution-code.line-numbers{data: {line: "3,6"}}
                  %code{class: "language-ruby"}
                    = @iteration.code

      .pure-u-1-2.rhs
        .discussion
          .discussion-header
            =link_to "Scroll to latest comment", ""
            %h3 Mentor Discussion
          - @iteration.discussion_posts.each do |post|
            .post
              =image_tag post.user.avatar_url, class: 'avatar'
              .post-body
                .post-header
                  .created-at Responded #{time_ago_in_words(post.created_at)} ago
                  .user-name= post.user.name
                  .user-status Ruby Mentor

                .post-html= raw post.html

          =form_for DiscussionPost.new, remote: true, html: {class: "new-discussion-post-form"} do |f|
            =hidden_field_tag :iteration_id, @iteration.id

            .tabs-and-panes.selected-1
              .tabs
                .tab.tab-1{data: {tab: "markdown"}} Write
                .tab.tab-2.preview-tab{data: {tab: "preview"}} Preview
              .panes
                .pane.pane-1.markdown
                  =f.text_area :content
                .pane.pane-2.preview
                  .preview-area

            =button_tag "Post Comment"

          .next-steps
            %h3
              %i.fa.fa-arrow-right
              Next Steps

            -if @iteration.mentor_status == "pending"
              %p A mentor will review your submission shortly and provide feedback.
            -if @iteration.mentor_status == "reply"
              %p Your mentor has suggested you should discuss this further before continuing.
            -if @iteration.mentor_status == "refactor"
              %p Your mentor has suggested that you refactor your code and provide another attempt.
            -if @iteration.mentor_status == "approved"
              %p Your mentor has approved this!
              =button_to "COMPLETE CTA HERE", ""

    .solution-footer
      .pure-g
        .pure-u-1-2
          /Other Solutions
        .pure-u-1-2
          -if @solution.approved?
            =link_to "Mark as completed", complete_solution_path(@solution), method: :patch, remote: true
          -else
            =link_to "Mark as completed", confirm_unapproved_completion_solution_path(@solution), method: :get, remote: true

    -#
      %h1 Your solution to #{@exercise.title}

      %p You're iterating!!

      %ul
        -@solution.iterations.each.with_index do |iteration, idx|
          %li
            -if iteration == @iteration
              = idx + 1
              (Selected)
            -else
              =link_to (idx + 1), solution_path(iteration_id: iteration.id)

      %h2 Code

      %h2 Discussion

-content_for :js do
  :coffeescript

    setupLayout = =>
      $lhs = $('.lhs')
      $lhs_content = $('.lhs-content')
      $lhs_content.css
        left: $lhs.position().left
        width: $lhs.outerWidth()

    $window = $(window)
    $lhs = $('.lhs')
    $window.scroll =>
      if $window.scrollTop() > $lhs.position().top - 10
        $lhs.addClass('fixed')
      else
        $lhs.removeClass('fixed')

    $window.resize setupLayout

    ###
    #panelsHeight = $(window).height() - $('.panels').position().top - $('.solution-footer').outerHeight() - 10
    panelsHeight = $(window).height() - $('.solution-footer').outerHeight() - 10
    $('.panels').css('max-height', panelsHeight)
    ###

    ###
    panesHeight = $('.panels').outerHeight() - 50
    $('.main-panes').css('height',)
    ###

    setupTabs = =>
      $('.tab').click ->
        $container = $(this).closest('.tabs-and-panes')
        console.log $container

        for c in $container[0].className.split(" ")
          $container.removeClass(c) if c.startsWith("selected-")

        tabId = null
        for c in this.className.split(" ")
          tabId = c.replace("tab-", "") if c.startsWith("tab-")

        $container.addClass("selected-\#{tabId}") if tabId

    setupNewDiscussionPost = =>

      $textarea = $(".new-discussion-post-form textarea")
      smde = new SimpleMDE
        element: $textarea[0]
        spellChecker: false
        forceSync: true
        toolbar: ["bold", "italic", "strikethrough", "|", "quote", "code", "link", "|", "unordered-list", "ordered-list"]

      console.log smde.toolbar

      $('.preview-tab').click ->
        markdown = $textarea.val()
        $.post "/markdown/parse", {markdown: markdown}, (x,y,z) =>
          console.log x,y,z
          $('.new-discussion-post-form .preview-area').html(x)
          Prism.highlightAll()

    setupTabs()
    setupLayout()
    setupNewDiscussionPost()
