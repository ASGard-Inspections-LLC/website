#solution-iterating-page
  .lo-container
    .placeholder-header
    .pure-g.panels
      .pure-u-1-2.lhs
        .lhs-content
          .tabs-and-panes.selected-3
            .tabs
              .tab.tab-1
                Instructions
              .tab.tab-2
                Test Suite
              .tab.tab-3
                Latest Solution

            .panes
              .pane.pane-1
                Instructions Pane
              .pane.pane-2
                Test Suite Pane
              .pane.pane-3.solution
                %pre.line-numbers{data: {line: "3,6"}}
                  %code{class: "language-ruby"}
                    = @iteration.code

      .pure-u-1-2.rhs
        .discussion
          .discussion-header
            =link_to "Scroll to latest comment", ""
            %h3 Mentor Discussion
          - @iteration.discussion_posts.each do |post|
            .post
              =image_tag post.user.avatar_url, class: 'avatar'
              .post-body
                .post-header
                  .created-at Responded #{time_ago_in_words(post.created_at)} ago
                  .user-name= post.user.name
                  .user-status Ruby Mentor

                .post-html= raw post.html

          =form_for DiscussionPost.new(iteration_id: @iteration), remote: true, html: {class: "new-discussion-post-form"} do |f|
            =f.hidden_field :iteration_id

            .tabs-and-panes.selected-1
              .tabs
                .tab.tab-1{data: {tab: "markdown"}} Write
                .tab.tab-2.preview-tab{data: {tab: "preview"}} Preview
              .panes
                .pane.pane-1.markdown
                  =f.text_area :content, value: "Foo\n\n```\nasdasdas\nasdasdas\n```\n\nqwewqe\nqweqweqw"
                .pane.pane-2.preview
                  .preview-area

            =button_tag "Post Comment"

          .next-steps
            %h3
              %i.fa.fa-arrow-right
              Next Steps

            -if @iteration.mentor_status == "pending"
              %p A mentor will review your submission shortly and provide feedback.
            -if @iteration.mentor_status == "reply"
              %p Your mentor has suggested you should discuss this further before continuing.
            -if @iteration.mentor_status == "refactor"
              %p Your mentor has suggested that you refactor your code and provide another attempt.
            -if @iteration.mentor_status == "approved"
              %p Your mentor has approved this!
              =button_to "COMPLETE CTA HERE", ""

    .solution-footer
      .pure-g
        .pure-u-1-2
          /Other Solutions
        .pure-u-1-2
          -if @solution.approved?
            =link_to "Mark as completed", complete_solution_path(@solution), method: :patch, remote: true
          -else
            =link_to "Mark as completed", confirm_unapproved_completion_solution_path(@solution), method: :get, remote: true

    -#
      %h1 Your solution to #{@exercise.title}

      %p You're iterating!!

      %ul
        -@solution.iterations.each.with_index do |iteration, idx|
          %li
            -if iteration == @iteration
              = idx + 1
              (Selected)
            -else
              =link_to (idx + 1), solution_path(iteration_id: iteration.id)

      %h2 Code

      %h2 Discussion

-content_for :js do
  :coffeescript

    setupLayout = =>
      $lhs = $('.lhs')
      $lhs_content = $('.lhs-content')
      $lhs_content.css
        left: $lhs.position().left
        width: $lhs.outerWidth()

    $window = $(window)
    $lhs = $('.lhs')
    $window.scroll => 
      if $window.scrollTop() > $lhs.position().top - 10
        $lhs.addClass('fixed')
      else
        $lhs.removeClass('fixed')


      ###
      #panelsHeight = $(window).height() - $('.panels').position().top - $('.solution-footer').outerHeight() - 10
      panelsHeight = $(window).height() - $('.solution-footer').outerHeight() - 10
      $('.panels').css('max-height', panelsHeight)
      ###

      ###
      panesHeight = $('.panels').outerHeight() - 50
      $('.main-panes').css('height',)
      ###

    setupTabs = =>
      $('.tab').click ->
        $container = $(this).closest('.tabs-and-panes')
        console.log $container

        for c in $container[0].className.split(" ")
          $container.removeClass(c) if c.startsWith("selected-")

        tabId = null
        for c in this.className.split(" ")
          tabId = c.replace("tab-", "") if c.startsWith("tab-")

        $container.addClass("selected-\#{tabId}") if tabId

    setupNewDiscussionPost = =>
      $('.preview-tab').click ->
        markdown = $(".new-discussion-post-form textarea").val()
        $.post "/markdown/parse", {markdown: markdown}, (x,y,z) =>
          console.log x,y,z
          $('.new-discussion-post-form .preview-area').html(x)
          Prism.highlightAll()

    setupTabs()
    setupLayout()
    setupNewDiscussionPost()
