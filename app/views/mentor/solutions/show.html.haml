#mentor-solution-page
  #nav.lo-nav-bar
    .lo-container
      =link_to "Mentor Dashboard", [:mentor, :dashboard]
      =image_tag "nav-divider.png"
      %span #{display_name(@solution.user, @solution_user_track)}'s solution to #{@exercise.title}

  .track-header
    .lo-container
      =image_tag display_avatar_url @solution.user, @solution_user_track
      .inner
        =render "solutions/iteration_nav", url_parts: [:mentor, @solution], iteration_idx: @iteration_idx, num_iterations: @num_iterations
        %h2
          Solution to
          %strong #{@exercise.title}
        .byline by #{display_name_link(@solution.user, @solution_user_track)}

  .lo-container
    .pure-g.panels
      .pure-u-1-2.lhs
        .lhs-content
          .tabs-and-panes.selected-3
            .tabs
              .tab.tab-1
                Instructions
              .tab.tab-2
                Test Suite
              .tab.tab-3
                Latest Solution

            =render "solutions/panes", iteration: @iteration

      .pure-u-1-2.rhs
        .discussion
          %h3 Mentor Discussion
          -if @iteration.discussion_posts.size > 0
            .posts
              =render partial: "mentor/discussion_posts/post", collection: @iteration.discussion_posts, locals: {solution: @solution}
          -else
            .posts{style: "display:none"}

          =form_for [:mentor, DiscussionPost.new], remote: true, html: {class: "new-discussion-post-form"} do |f|
            =hidden_field_tag :iteration_id, @iteration.id

            .tabs-and-panes.selected-1
              .tabs
                .tab.tab-1{data: {tab: "markdown"}} Write
                .tab.tab-2.preview-tab{data: {tab: "preview"}} Preview
              .panes
                .pane.pane-1.markdown
                  =f.text_area :content
                .pane.pane-2.preview
                  .preview-area

            =button_tag "Comment", class: 'pure-button'

    -#
      .solution-footer
        .pure-g
          .pure-u-1-2
            /Other Solutions
          .pure-u-1-2
            -unless @solution.completed?
              -if @solution.approved?
                =link_to "Mark as completed", [:complete, :my, @solution], method: :patch, remote: true
              -else
                =link_to "Mark as completed", [:confirm_unapproved_completion, :my, @solution], method: :get, remote: true

    -#
      %h1 Your solution to #{@exercise.title}

      %p You're iterating!!

      %ul
        -@solution.iterations.each.with_index do |iteration, idx|
          %li
            -if iteration == @iteration
              = idx + 1
              (Selected)
            -else
              =link_to (idx + 1), solution_path(iteration_id: iteration.id)

      %h2 Code

      %h2 Discussion

-content_for :js do
  :coffeescript

    setupLayout = =>
      $lhs = $('.lhs')
      $lhs_content = $('.lhs-content')
      $lhs_content.css
        left: $lhs.position().left
        width: $lhs.outerWidth()

    $window = $(window)
    $lhs = $('.lhs')
    # TODO - Reenalbe and fix the disco
    #$window.scroll =>
    #  if $window.scrollTop() > $lhs.position().top - 10
    #    $lhs.addClass('fixed')
    #  else
    #    $lhs.removeClass('fixed')


    ###
    #panelsHeight = $(window).height() - $('.panels').position().top - $('.solution-footer').outerHeight() - 10
    panelsHeight = $(window).height() - $('.solution-footer').outerHeight() - 10
    $('.panels').css('max-height', panelsHeight)
    ###

    ###
    panesHeight = $('.panels').outerHeight() - 50
    $('.main-panes').css('height',)
    ###

    setupTabs = =>
      $('.tab').click ->
        $container = $(this).closest('.tabs-and-panes')
        console.log $container

        for c in $container[0].className.split(" ")
          $container.removeClass(c) if c.startsWith("selected-")

        tabId = null
        for c in this.className.split(" ")
          tabId = c.replace("tab-", "") if c.startsWith("tab-")

        $container.addClass("selected-\#{tabId}") if tabId

    setupNewDiscussionPost = =>
      $textarea = $(".new-discussion-post-form textarea")
      smde = new SimpleMDE
        element: $textarea[0]
        spellChecker: false
        forceSync: true
        status: false
        toolbar: ["bold", "italic", "strikethrough", "|", "quote", "code", "link", "|", "unordered-list", "ordered-list"]

      $('.preview-tab').click ->
        markdown = $textarea.val()
        $.post "/markdown/parse", {markdown: markdown}, (x,y,z) =>
          console.log x,y,z
          $('.new-discussion-post-form .preview-area').html(x)
          Prism.highlightAll()

      $('.CodeMirror').bind 'heightChange', =>
        $('.preview-area').css(height: $('.CodeMirror').outerHeight())

    setupTabs()
    setupLayout() #Â TODO - Reenable but stop the disco thing!
    setupNewDiscussionPost()

    $window.resize setupLayout

