#my-settings-page
  #nav.lo-nav-bar
    .lo-container
      /=link_to "Dashboard", root_path
      /=image_tag "nav-divider.png"
      %span Settings

  = notice_and_alert(current_user)
  .lo-container
    %h1 Account Settings
    .pure-g
      .pure-u-1-3.lhs
        %h2 CLI Token
        .token-explanation Your authentication token for the CLI is:
        =render "widgets/code_snippet", code: current_user.auth_token

        %h2 Change your password
        %p You can change your password at any point.

        =form_for current_user, url: [:my, :settings] do |f|
          -unless current_user.provider?
            .field
              =label_tag :old_password, "Enter your current password"
              =password_field :old_password

          .field
            =f.label :password, "Enter your new password"
            =f.password_field :password

          .field
            =f.label :password_confirmation, "Confirm your current password"
            =f.password_field :password_confirmation

          =button_tag "Update Password", class: 'pure-button'

      .pure-u-2-3.rhs
        %h2 Privacy
        %p You can choose to be anonymous on each track.
        =form_tag [:update_user_tracks, :my, :settings], method: :patch do |f|
          -@user_tracks.each do |user_track|
            .track
              .title #{user_track.track.title} Track
              =check_box_tag "user_tracks[#{user_track.id}][anonymous]", 1, user_track.anonymous?, class: 'anonymous-toggle'
              .toggles
                %i.fa.fa-toggle-on
                %i.fa.fa-toggle-off
              =text_field_tag "user_tracks[#{user_track.id}][handle]", user_track.handle, placeholder: "Choose an alias for this track", required: user_track.anonymous?

          =button_tag "Update Privacy Settings", class: 'pure-button'

-content_for :js do
  :javascript
    $('.anonymous-toggle').change(function(){
      var $checkbox = $(this)
      var $handle = $checkbox.next().next()
      $handle.attr('required', $checkbox.prop('checked'))
    })
